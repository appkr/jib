## How to build a native image on MacOS

Reference: https://www.graalvm.org/latest/reference-manual/native-image/dynamic-features/Resources/

By default, the native-image tool will not integrate any of the resources
that are on the classpath into the native executable.
To make calls such as `Class.getResource()` or `Class.getResourceAsStream()`
(or their corresponding `ClassLoader` methods) return specific resources (instead of null),
you must specify the resources that should be accessible at runtime.
This can be achieved using a configuration files generated by the following process.

#### 1 Install a GraalVM from [Release page](https://github.com/graalvm/graalvm-ce-builds/releases)

Download one: 1.8 is no more support, choose 11, 17, or 20
```shell
VMDIR=/Library/Java/JavaVirtualMachines
wget https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-22.3.3/graalvm-ce-java11-darwin-amd64-22.3.3.tar.gz
```

Untar and install; Remove the quarantine attribute of MacOS
```shell
GRDIR=graalvm-ce-java11-22.3.3
tar -xvf graalvm-ce-java11-darwin-amd64-22.3.3.tar.gz
sudo mv $GRDIR $VMDIR && rm -rf $GRDIR
```

Export PATH
```shell
export PATH=$VMDIR/$GRDIR/Contents/Home/bin:$PATH
```

Install `native-image` binary
```shell
gu install native-image
```

#### 2 Build and executable and generate the metadata

Build
```shell
./gradlew :jib-cli:installDist
```

Run all sub-commands, so that the generated configuration is as much as complete
```shell
CLASSPATH=./jib-cli/build/install/jib/lib/*
MAIN_FQCN=com.google.cloud.tools.jib.cli.JibCli
META_DIR=./jib-cli/src/main/resources/META-INF/native-image
MY_REGISTRY= # e.g. your docker username, OR full registry path

java -agentlib:native-image-agent=config-merge-dir=$META_DIR -cp $CLASSPATH $MAIN_FQCN
java -agentlib:native-image-agent=config-merge-dir=$META_DIR -cp $CLASSPATH $MAIN_FQCN build -b jib-cli/quickstart/jib.yaml -c jib-cli/quickstart --target=$MY_REGISTRY/jib-cli-quickstart
# run jib and tar command too
```

#### 3 Build native image

Build
```shell
./gradlew nativeCompile -DgraalvmNative.agent.enabled=true
# Finished generating 'jib-cli' in 2m 9s.
#    [native-image-plugin] Native Image written to: /pathto/jib/jib-cli/build/native/nativeCompile
# BUILD SUCCESSFUL in 2m 25s
```

Run
```shell
/pathto/jib/jib-cli/build/native/nativeCompile/jib-cli
# Missing required subcommand
# Usage: jib [-hV] [@<filename>...] COMMAND
# Run 'jib --help' for more information on usage.
```

#### 4 To download & install the native binary

```shell
PROJECT=  # e.g. https://github.com/GoogleContainerTools/jib
VERSION=
OS=       # e.g. macos
ARCH=     # e.g. amd64
wget $PROJECT/releases/download/$VERSION/jib-cli-$VERSION-$OS-$ARCH.zip
sudo unzip jib-cli-$VERSION-$OS-$ARCH.zip -d /usr/local/bin/jib

# To add an application to MacOS Gatekeeper's exceptions
spctl --add /usr/local/bin/jib
```
